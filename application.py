# coding=utf8
from dash import Dash, callback, html, dcc, dash_table, Input, Output, State, MATCH, ALL
from dash.exceptions import PreventUpdate
import dash_bootstrap_components as dbc
import plotly.express as px
import plotly.graph_objs as go
import locale
import re
import pandas as pd
import random


# External stylesheets and scripts
FA = "https://use.fontawesome.com/releases/v5.10.2/css/all.css"
external_stylesheets = [dbc.themes.FLATLY, FA]
external_scripts = ["https://cdn.plot.ly/plotly-locale-bg-latest.js"]


# Read csv files
unigram_full_df = pd.read_csv("data/unigram_full_df.csv", index_col=0, parse_dates=['date'])
bigram_full_df = pd.read_csv("data/bigram_full_df.csv", index_col=0, parse_dates=['date'])

# Main app 
app = Dash(__name__, external_stylesheets=external_stylesheets, external_scripts=external_scripts)
app.title = '–ó–∞ –∫–∞–∫–≤–æ –≥–æ–≤–æ—Ä–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏—è—Ç Reddit - Ngram –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'
application = app.server

fig = go.Figure()
fig.update_xaxes(showgrid=False, ticks="inside")
fig.update_yaxes(tickformat = '%')
fig.update_layout(hovermode="x unified", template = "plotly_white", xaxis=dict(tickformat="%B-%Y"), hoverlabel_namelength=-1)


def data_missing(df):
    if len(df) <= 1:
        missing_data = True
    else:
        missing_data = False
    return missing_data

def check_string(string):
    ngram = len(string.split())
    string = string.lower()
    string = string.rstrip()
    string = string.lstrip()
    if ngram == 1 :
        df = unigram_full_df[unigram_full_df['gram'] == string]
        missing_state = data_missing(df)
        forbidden_state = False
    elif ngram == 2:
        df = bigram_full_df[bigram_full_df['gram'] == string]
        missing_state = data_missing(df)
        forbidden_state = False
    elif ngram == 0:
        df = 0
        forbidden_state = False
        missing_state = True
        raise PreventUpdate
    else:
        df = 0
        print("–ó–∞ –º–æ–º–µ–Ω—Ç–∞ –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞—Ç —Ñ—Ä–∞–∑–∏ —Å –ø–æ–≤–µ—á–µ –æ—Ç 2 –¥—É–º–∏.")
        forbidden_state = True
        missing_state = True
    return df, forbidden_state, missing_state

app.layout = dbc.Container([
            
            dbc.Navbar(
                dbc.Container(
                    [
                        html.H2("–ó–∞ –∫–∞–∫–≤–æ –∏ –∫–æ–≥–æ –≥–æ–≤–æ—Ä–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏—è—Ç Reddit?", className="text_gradient"),
                    ]
                ), 
            ),
            html.Hr(className="line_gradient"),
            dbc.Row([
            dbc.Col([
            ], md=1),     
            dbc.Col([
            dbc.Button('üé≤ –°–ª—É—á–∞–π–Ω–∏ –∏–¥–µ–∏', id='random_shuffle', color="dark", className='d-flex justify-content-center', outline=True, style={'font-size' : '12px',  'text-align' : 'center', 'margin-left': '25%'}),
            ], md=2), 
            dbc.Col([
            html.Div([
            html.Div(dbc.Button('üîç',id='search', color='light', outline=True, style={'padding':'7px', 'color': '#fff','border-color': '#fff'}), style={'display' : 'inline-block', 'vertical-align': 'middle'}),
            dbc.Tooltip(
                 "–¢—ä—Ä—Å–∏",
                 target="search",
                 placement="bottom",
             ),
            html.Div(
                dbc.Input(
                id="input",
                type="text",
                debounce=True,
                minLength=3,
                # maxLength=100
                placeholder="–¢—ä—Ä—Å–∏ –¥—É–º–∏, –∏–º–µ–Ω–∞, —Ñ—Ä–∞–∑–∏...",
                style = {'width' : '100%'}
            ), style={'display' : 'inline-block', 'vertical-align': 'middle', 'width' : '90%'}),
            ])], md=6),
            
            dbc.Col([
            html.P("–ü–æ–¥–≤–∏–∂–Ω–∞ —Å—Ä–µ–¥–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç", id="inter", style={'font-size' : '12px', 'text-align' :'center', 'padding' : '0px', 'margin' : '0px'}),
            dcc.Slider(min=1, max=12, value=1, step=1, id='smoothing', drag_value=1, marks=None,
            tooltip={"placement": "bottom", "always_visible": True},
            className="smoothing_slider"),
            dbc.Tooltip(
                  "–ò–∑—Ä–∞–≤–Ω—è–≤–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ —Å –ø–æ–¥–≤–∏–∂–Ω–∞ —Å—Ä–µ–¥–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç. 1 —Å–∞ —Å—É—Ä–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω–∏, 2 –µ —Å—Ä–µ–¥–Ω–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –∑–∞ –¥–≤–∞ –º–µ—Å–µ—Ü–∞, 3 –µ —Å—Ä–µ–¥–Ω–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –∑–∞ –º–µ—Å–µ—Ü–∞ –∏ —Ç.–Ω.",
                  target="inter",
                  placement="top"
              ),
            ], md=2, style={'padding-left': '2%'}),
            
            dbc.Col([
            ], md=1) 
            ], align="center", style={'margin-top' : '50px', 'padding-bottom' : '15px'}, className="g-0",
            ),
            
            dbc.Row([
                
            dbc.Col([
            ], md=3),
            dbc.Col([
            dbc.Alert(
                children=[],
                id="alert-missing",
                dismissable=True,
                is_open=False,
                color="danger",
                style={'font-size' : '13px'}
            ),
            dbc.Alert(
                "–ó–∞ –º–æ–º–µ–Ω—Ç–∞ –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞—Ç —Ñ—Ä–∞–∑–∏ —Å –ø–æ–≤–µ—á–µ –æ—Ç 2 –¥—É–º–∏.",
                id="alert-fade",
                dismissable=True,
                is_open=False,
                color="danger",
                style={'font-size' : '13px'}
            ),     
            ], md=6),    
            dbc.Col([
            ], md=3) 
            
            ], align="center", className="g-0"),
            
            dbc.Row([
            dbc.Col([
            ], md=1), 
            dbc.Col([
            dcc.Loading(
            id="loading-graph",
            type="dot",
            color="#82888a",
            children=dcc.Graph(figure=fig, config=dict({'scrollZoom': False, "displaylogo": False, 'displayModeBar': False, 'showAxisDragHandles': False, 'locale' : 'bg'}),
            id='main_graph'))
            ], md=10),
            dbc.Col([
            ], md=1) 
            ], align="center", className="g-0",
            ),
            
            dbc.Row([
                dbc.Col([], md=3),
                dbc.Col([
                dcc.Markdown('''–ë—ä–ª–≥–∞—Ä—Å–∫–∏—è—Ç Reddit (r/bulgaria) –µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª–Ω–æ –º–∞–ª–∫–æ –∫—ä—Ç—á–µ –≤ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ—Ç–æ, –Ω–æ –ø—ä–∫ –≤ –Ω–µ–≥–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏—Ç–µ –¥–∏—Å–∫—É—Ç–∏—Ä–∞—Ç –∞–∫—Ç—É–∞–ª–Ω–∏ —Å—ä–±–∏—Ç–∏—è –∑–∞ —Å—Ç—Ä–∞–Ω–∞—Ç–∞ –∏ –±–∏ –±–∏–ª–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –¥–∞ —Å–µ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞—Ç —Ç—Ä–µ–Ω–¥–æ–≤–µ –∑–∞ —Ä–∞–∑–ª–∏—á–Ω–∏—Ç–µ —Ç–µ–º–∏, —Ö–æ—Ä–∞ –∏ —Å—ä–±–∏—Ç–∏—è, –∫–æ–∏—Ç–æ —Å–µ –æ–±—Å—ä–∂–¥–∞—Ç —Ç–∞–º. 
                –ó–∞ —Ç–∞–∑–∏ —Ü–µ–ª —Å—ä–∑–¥–∞–¥–æ—Ö —Ç–æ–∑–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –≤–¥—ä—Ö–Ω–æ–≤–µ–Ω –æ—Ç [Google Books Ngram Viewer](https://books.google.com/ngrams). 
                –í—ä–≤–µ–¥–µ—Ç–µ —Ä–∞–∑–ª–∏—á–Ω–∏ —Ñ—Ä–∞–∑–∏ –≤ —Ç—ä—Ä—Å–∞—á–∫–∞—Ç–∞ (—Å –Ω–∞—Ç–∏—Å–∫–∞–Ω–µ –Ω–∞ –±—É—Ç–æ–Ω–∞ –∏–ª–∏ –∫–ª–∞–≤–∏—à Enter) –∏ —â–µ –ø–æ–ª—É—á–∏—Ç–µ –≥—Ä–∞—Ñ–∏–∫–∞, –∫–æ—è—Ç–æ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–∞ –∫–æ–ª–∫–æ —á–µ—Å—Ç–æ —Ç–µ–∑–∏ —Ñ—Ä–∞–∑–∏ —Å–∞ –±–∏–ª–∏ —Å–ø–æ–º–µ–Ω–∞—Ç–∏ –≤ [reddit.com/r/bulgaria](https://www.reddit.com/r/bulgaria/) –ø—Ä–µ–∑ –¥–∞–¥–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥. 
                –î–∞–Ω–Ω–∏—Ç–µ –±—è—Ö–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ –æ—Ç –≤—Å–∏—á–∫–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä–∏ (–æ–∫–æ–ª–æ 735 000) –≤ –±—ä–ª–≥–∞—Ä—Å–∫–∏—è—Ç subreddit ‚Äì r/bulgaria –æ—Ç –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ 2016 –≥–æ–¥–∏–Ω–∞ –¥–æ –º–∞–π 2022 –≥–æ–¥–∏–Ω–∞.  
                –ü–æ–≤–µ—á–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ç–æ–≤–∞ –∫–∞–∫ –±—è—Ö–∞ —Å–≤–∞–ª–µ–Ω–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–µ–Ω–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä–∏—Ç–µ, –∏ –∫–∞–∫ –±–µ—à–µ —Å—ä–∑–¥–∞–¥–µ–Ω Ngram –º–æ–¥–µ–ª—ä—Ç –º–æ–∂–µ –¥–∞ –ø—Ä–æ—á–µ—Ç–µ –≤ —Ç–æ–∑–∏ [–±–ª–æ–≥ –ø–æ—Å—Ç](https://ivaylo.xyz/posts/2022-06-20-reddit-ngram-viewer/).\n –û—Ç–≤–æ—Ä–µ–Ω–∏—è—Ç –∫–æ–¥ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –º–æ–∂–µ –¥–∞ —Ä–∞–∑–≥–ª–µ–¥–∞—Ç–µ (–∏ –∏–∑–ø–æ–ª–∑–≤–∞—Ç–µ –∫–∞–∫—Ç–æ —Å–∏ –ø–æ–∂–µ–ª–∞–µ—Ç–µ) –≤ [Github](https://github.com/sakelariev/bg-reddit).\n 
*\*–ê–±—Å–æ–ª—é—Ç–µ–Ω –±—Ä–æ–π –∏–º–∞ –¥–æ—Å—Ç—ä–ø–µ–Ω —Å–∞–º–æ –ø—Ä–∏ —Å—É—Ä–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω–∏ (–ü–æ–¥–≤–∏–∂–Ω–∞ —Å—Ä–µ–¥–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç = 1).*
                ''')
                ],
                md=6),
            
                dbc.Col([], md=3)
            ], style={
                                "position":"relative",
                                "bottom":0,
                                "padding-bottom": "30px",
                                "margin-top": "30px",
                            }),
            
            ], fluid=True)
    
# For the callback I have two options - either with Input(n_submit) + State or with Input(value) and debounce=True,
@app.callback(
  Output(component_id='main_graph', component_property='figure'),
  Input(component_id='search', component_property='n_clicks'),
  Input(component_id='smoothing', component_property='value'),
  Input(component_id='input', component_property='value'),
  )
def update_figure(n_clicks, smoothing, string):
  fig = go.Figure()
  colors_list = px.colors.qualitative.Plotly
  for count, element in enumerate(string.split(',')):
      df = check_string(element)[0]
      double_check = check_string(element)[1]
      check_missing = check_string(element)[2]
      element = element.rstrip()
      element = element.lstrip()
      # Fill in all missing monthly values with 0 - this makes the plot look correct now
      df = (df.set_index('date').reindex(pd.date_range('2016-01-01', '2022-05-01', freq='MS')).rename_axis(['date']).fillna(0).reset_index())
      df['average'] = df.ratio.rolling(smoothing).mean()
      df['average_count'] = df['count'].rolling(smoothing).mean().round(0)
      if double_check == False and check_missing == False:
          if smoothing <= 1:
              fig.add_trace(go.Scatter(x=df['date'], y=df['ratio'],
                                  mode='lines',
                                  name=element,
                                  customdata=df[['count']], 
                                  legendgroup=element,
                                  line_shape='spline',
                                  line={'smoothing' : 0.6, 'color' : colors_list[count]},
                                  hovertemplate='<b>%{y}</b> <br>–ê–±—Å–æ–ª—é—Ç–µ–Ω –±—Ä–æ–π<sup>*</sup>: %{customdata[0]}'
                                  ))
              # add traces for annotations and text for end of lines
              fig.add_scatter(x=df['date'].tail(1), y=df['ratio'].tail(1),
               mode='text',
               text=" " + element,
               hoverinfo='skip',
               hovertemplate=None,
               textfont=dict(color=colors_list[count]),
               textposition='middle right',
               cliponaxis=False,
               legendgroup=element,
               showlegend=False)
          else:
              fig.add_trace(go.Scatter(x=df['date'], y=df['average'],
              mode='lines',
              name=element,
              # customdata=df[['average_count']], 
              legendgroup=element,
              line_shape='spline',
              line={'smoothing' : 0.6, 'color' : colors_list[count]},
              # hovertemplate='<b>%{y}</b> <br>–ê–±—Å–æ–ª—é—Ç–µ–Ω –±—Ä–æ–π(–ø–æ–¥–≤–∏–∂–Ω–∞ —Å—Ä–µ–¥–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç): %{customdata[0]}'
              ))
              # add traces for annotations and text for end of lines
              fig.add_scatter(x=df['date'].tail(1), y=df['average'].tail(1),
                mode='text',
                text=" " + element,
                hoverinfo='skip',
                hovertemplate=None,
                cliponaxis=False,
                textfont=dict(color=colors_list[count]),
                textposition='middle right',
                legendgroup=element,
                showlegend=False)

      # fig.update_traces(hovertemplate=None, connectgaps=True)
      fig.update_traces(connectgaps=True)
      fig.update_xaxes(showgrid=False, ticks="inside", tickangle=0, ticklabelstep=1)
      fig.update_yaxes(tickformat = '%')
      fig.update_layout(hovermode="x unified", template = "plotly_white", xaxis=dict(tickformat="%B<br>%Y"), hoverlabel_namelength=-1, legend=dict(orientation="h", yanchor="bottom", y=1.03, xanchor="center", x=0.5))
  return fig


# Second callback is for notifications
@app.callback(
    Output(component_id='alert-fade', component_property='is_open'),
    Input(component_id='input', component_property='value'),
    [State("alert-fade", "is_open")],
    )
def trigger_notification(string, is_open):
    for element in string.split(','):
        double_check = check_string(element)[1]
        if double_check:
            is_open = True
        else:
            is_open = False
    return is_open

# Alert for when some phrase is missing from the data
@app.callback(
   [Output(component_id='alert-missing', component_property='is_open'),
    Output(component_id='alert-missing', component_property='children')],
    Input(component_id='input', component_property='value'),
    [State("alert-missing", "is_open")],
    )
def trigger_notification(string, is_open):
    for element in string.split(','):
        check_missing = check_string(element)[2]
        if check_missing:
            is_open = True
            message = dcc.Markdown("**{}** –ª–∏–ø—Å–≤–∞ –æ—Ç –¥–∞–Ω–Ω–∏—Ç–µ.".format(element))
        else:
            is_open = False
            message = ''
    return is_open, message
    
# Shuffle random ideas to explore the tool
@app.callback(
    Output(component_id='input', component_property='value'),
    Input(component_id='random_shuffle', component_property='n_clicks'),
    State(component_id='input', component_property='value'),
    )
def shuffle_random_ideas(n_clicks, current_value):
    random_ideas = ["–õ–µ–≤—Å–∫–∏,–¶–°–ö–ê,–õ—É–¥–æ–≥–æ—Ä–µ—Ü", "–ö–æ–ø–µ–π–∫–∏–Ω,–ö–æ—Å—Ç—è,–ö–æ—Å—Ç–∞–¥–∏–Ω –ö–æ—Å—Ç–∞–¥–∏–Ω–æ–≤", "–ë–æ–π–∫–æ –ë–æ—Ä–∏—Å–æ–≤,–ö–∏—Ä–∏–ª –ü–µ—Ç–∫–æ–≤", "–í—ä–∑—Ä–∞–∂–¥–∞–Ω–µ,–î–ë,–ì–ï–†–ë,–ë–°–ü,–ò–¢–ù", "–ö–æ–≤–∏–¥,–í–∞–∫—Å–∏–Ω–∞", "–£–∫—Ä–∞–π–Ω–∞,–†—É—Å–∏—è,–°–ê–©","–ú–µ—Ä–∫–µ–ª,–û—Ä–±–∞–Ω", "–ü—É—Ç–∏–Ω,–ï—Ä–¥–æ–≥–∞–Ω", "–ì–µ—à–µ–≤,–ë–æ—Ä–∏—Å–æ–≤", "–°–ª–∞–≤–∏,–ë–æ–π–∫–æ", "–æ–ª–∏–æ,–∑–µ—Ö—Ç–∏–Ω", "–∏–Ω—Ñ–ª–∞—Ü–∏—è,–∫—Ä–µ–¥–∏—Ç", "–ù–ê–¢–û,–ï–°", "—Ñ–∞–ª—à–∏–≤–∏ –Ω–æ–≤–∏–Ω–∏,fake news", "–æ—Ä–∫–∏"]
    draw_random = random.choice(random_ideas)
    if draw_random == current_value:
        random_ideas.remove(current_value)
        draw_random = random.choice(random_ideas)
    return draw_random


if __name__ == '__main__':
    app.run_server(debug=False)